<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDDCA-De2_NIF5TWvMBOOLRRH2uvTN46Es",
    authDomain: "meugeradordeprompts.firebaseapp.com",
    projectId: "meugeradordeprompts",
    storageBucket: "meugeradordeprompts.firebasestorage.app",
    messagingSenderId: "301051793324",
    appId: "1:301051793324:web:1bbbd148b7e848e1397409"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const favsCollection = collection(db, "prompts");

  // Salvar no Firebase
  window.saveToFavorites = async function() {
    const promptText = document.getElementById('output').value;
    if (!promptText) return alert("Gere um prompt primeiro!");

    try {
      await addDoc(favsCollection, {
        text: promptText,
        createdAt: new Date()
      });
      console.log("Salvo no Google Cloud!");
    } catch (e) {
      alert("Erro ao salvar. Verifique se as Regras do Firestore estão em 'modo de teste'.");
    }
  };

  // Deletar do Firebase
  window.deleteFromGoogle = async function(id) {
    if(confirm("Excluir da nuvem?")) {
      await deleteDoc(doc(db, "prompts", id));
    }
  };

  // Escutar favoritos em tempo real
  const q = query(favsCollection, orderBy("createdAt", "desc"));
  onSnapshot(q, (snapshot) => {
    const list = document.getElementById('favoritesList');
    list.innerHTML = "";
    snapshot.forEach((documento) => {
      const data = documento.data();
      const id = documento.id;
      const cleanText = data.text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
      
      const item = document.createElement('div');
      item.className = "flex gap-1 items-center bg-black/50 p-2 rounded mb-1 border border-gray-800";
      item.innerHTML = `
        <button onclick="navigator.clipboard.writeText('${cleanText}'); alert('Copiado!')" 
                class="text-[10px] truncate w-full text-left text-gray-400 hover:text-indigo-400">
          ${data.text}
        </button>
        <button onclick="deleteFromGoogle('${id}')" class="text-red-500 text-lg px-2 hover:bg-red-900/20 rounded">×</button>
      `;
      list.appendChild(item);
    });
  });
</script>
